<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="主要记录一些技术要点，主要怕忘，便于整理"><title>批量TIME_WAIT出现的原因和解决方案 | Novliang Lazy Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.1/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.1/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.1/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/2.0.4/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/2.1.4/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/2.1.4/toastr.min.css"><meta name="generator" content="Hexo 4.2.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">批量TIME_WAIT出现的原因和解决方案</h1><a id="logo" href="/.">Novliang Lazy Blog</a><p class="description">主要怕忘</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">批量TIME_WAIT出现的原因和解决方案</h1><div class="post-meta">2019-04-01</div><div class="post-content"><p>TIME_WAIT可能是面试过程中闻到的比较多的和网络编程方面的知识，很多人都知道TCP建立链接时候的三次握手，但是在断开链接时候的四次挥手却不是很熟悉。首先看下图<br><img src="http://q8xc36wvb.bkt.clouddn.com/4.png" alt="image"><br>TCP四次挥手过程如下:</p>
<ol>
<li>发起方发送FIN[k]报文,进入FIN_WAIT_1状态</li>
<li>接收方接收FIN[k]报文后进入CLOSE_WAIT状态并返回ACK[k+1]确认接收</li>
<li>接收方READ内容为EOF并通知程序主动关闭连接，发送FIN[n]报文到发起方，进入LAST_ACK状态</li>
<li>发起方接收FIN[n]报文后，返回ACK[n+1]确认报文，并进入<code>TIME_WAIT</code>状态</li>
</ol>
<p>一般而言，TIME_WAIT会在接收到接收方发送的FIN包时候开始，持续的时间是MSL(分节生命周期)的两倍，也就是2MSL，我在我的MAC系统上执行得到的结果如下，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~ sysctl net.inet.tcp.msl</span><br><span class="line">net.inet.tcp.msl: 15000</span><br></pre></td></tr></table></figure>
<p>也就是我这里的2MSL是30000毫秒也就是30s，但是在一般的FreeBSD和LINUX系统内的MSL都是30s，TIME_WAIT也就是60s。</p>
<p>从过程可以看出来，只有关闭<code>发起方</code>才会进入<code>TIME_WAIT</code>状态，那为什么不在最后步骤4发送确认报文后直接进入<code>CLOSED</code>状态而要进入<code>TIME_WAIT</code>状态呢？</p>
<p>主要有两方面的原因</p>
<p>1. 网络的连接和数据包的发送客观上是不可靠的，TCP带来的可靠性也是建立在维护连接给予重传、校验等机制带来的可靠性，所以在步骤4过后，TCP会假设会丢失包，那么处于LAST_ACK状态的接收方在超时后会再次发起FIN[n]报文，然后发起方再次发送确认报文，保证连接正确关闭。2MSL的时间足够应对这种情况。</p>
<ol start="2">
<li>主要和报文在网上可能经过一段时间才能实际到达接收方有关，例如我从4不经过2MSL最直接断开进入CLOSED状态后，再次和相同的主机的相同的端口建立了连接。类似(192.168.1.2:22,192.168.1.3:8976)，结果在网络中还游荡者步骤3发起的FIN请求，在新的连接建立后突然达到了接收方，会对通信造成影响。</li>
</ol>
<p>说了那么多，TIME_WAIT有什么危害呢？其实很简单，一个主机的可用端口数是固定的，如果存在大量的网络连接的请求，每次断开都要等待2MSL就会占用大量的端口，造成服务的不稳定，可能出现的情况就是服务的时可用时不可用。</p>
<p>处理TIME_WAIT的方式主要通过系统参数来限制处于TIME_WAIT这状态的连接数,调整<code>net.ipv4.tcp_max_tw_buckets</code>的数值来限制，一旦超过这个数值就会立刻重置全部处于TIME_WAIT的连接状态。</p>
<p>还有一种就像我的mac一样，吧这个TCP_TIMEWAIT_LEN调小</p>
<p>还有一种是复用处于TIME_WAIT状态的端口<br>在LINUX系统中打开<code>net.ipv4.tcp_tw_reuse</code>，可以复用处于TIME_WAIT状态超过1秒的套接字为新的连接使用。</p>
</div><div class="tags"><a href="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B-TCP-IP/"><i class="fa fa-tag"></i>网络编程,TCP/IP</a></div><div class="post-nav"><a class="pre" href="/2019/04/11/golang-make%E7%9A%84%E7%AC%AC%E4%B8%89%E4%B8%AA%E5%8F%82%E6%95%B0/">golang make的第三个参数</a><a class="next" href="/2019/04/01/hello-world/">初始篇</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://onno.ink"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B-TCP-IP/" style="font-size: 15px;">网络编程,TCP/IP</a> <a href="/tags/golang/" style="font-size: 15px;">golang</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 15px;">算法</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/04/14/%E3%80%90%E7%AE%97%E6%B3%95%E8%AE%AD%E7%BB%83%E3%80%91%E6%89%BE%E7%8C%B4%E7%8E%8B/">【算法训练】找猴王</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/11/golang-make%E7%9A%84%E7%AC%AC%E4%B8%89%E4%B8%AA%E5%8F%82%E6%95%B0/">golang make的第三个参数</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/01/time-wait/">批量TIME_WAIT出现的原因和解决方案</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/01/hello-world/">初始篇</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="http://wuqiang.net" title="wuqiang" target="_blank">wuqiang</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">Novliang Lazy Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="Copy Successed!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>